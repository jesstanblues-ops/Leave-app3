{% extends 'base.html' %}
{% block content %}

<h3>Admin Dashboard</h3>

<!-- YEAR SELECTOR -->
<form method="GET" action="/admin" class="mb-3">
  <label class="me-2"><strong>Year:</strong></label>
  <select name="year" onchange="this.form.submit()" class="form-select d-inline-block w-auto">
    {% for y in range(2023, 2031) %}
      <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
    {% endfor %}
  </select>
</form>

<p>
  <a href="/download_excel" class="btn btn-success mb-3">
      ðŸ“¥ Download All Leave Records (Excel)
  </a>
</p>

<!-- ===================== LEAVE REQUESTS ===================== -->
<h4>Leave Requests ({{ year }})</h4>
<table class="table table-sm table-bordered">
<thead>
<tr>
    <th>Employee</th>
    <th>Type</th>
    <th>Dates</th>
    <th>Days</th>
    <th>Reason</th>
    <th>Status</th>
    <th>Action</th>
</tr>
</thead>
<tbody>
{% for l in leaves %}
<tr>
    <td>{{ l.employee_name }}</td>
    <td>{{ l.leave_type }}</td>
    <td>{{ l.start_date }} â†’ {{ l.end_date }}</td>
    <td>{{ "%.2f"|format(l.days) }}</td>
    <td>{{ l.reason if l.reason else "â€“" }}</td>
    <td>{{ l.status }}</td>
    <td>
        {% if l.status == "Pending" %}
            <a class="btn btn-success btn-sm" href="/approve/{{ l.id }}">Approve</a>
            <a class="btn btn-danger btn-sm" href="/reject/{{ l.id }}">Reject</a>
        {% else %}
            â€“
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
</table>

<!-- ===================== ADD EMPLOYEE ===================== -->
<h4 class="mt-4">Add New Employee</h4>
<form method="POST" action="/add_employee" class="row g-2 mb-4">
    <div class="col-md-3">
        <input class="form-control" name="name" placeholder="Employee Name" required>
    </div>
    <div class="col-md-3">
        <input type="date" class="form-control" name="join_date" required>
    </div>
    <div class="col-md-3">
        <input type="number" class="form-control" name="entitlement" step="0.5" placeholder="Entitlement">
    </div>
    <div class="col-md-3">
        <button class="btn btn-success w-100">Add</button>
    </div>
</form>

<!-- ===================== EMPLOYEES ===================== -->
<h4>Employees (Balances for {{ year }})</h4>
<table class="table table-sm table-bordered">
<thead>
<tr>
    <th>Name</th>
    <th>Total Entitlement</th>
    <th>Used</th>
    <th>Remaining</th>
    <th>Update Entitlement</th>
    <th>Update Balance</th>
    <th>Rename</th>
    <th>Delete</th>
</tr>
</thead>

<tbody>
{% for b in balances %}
<tr>
    <td>{{ b.employee_name }}</td>
    <td>{{ "%.2f"|format(b.total_entitlement) }}</td>
    <td>{{ "%.2f"|format(b.used) }}</td>
    <td><strong>{{ "%.2f"|format(b.remaining) }}</strong></td>

    <!-- Update Entitlement -->
    <td>
        <form method="POST" action="/update_entitlement" class="d-flex">
            <input type="hidden" name="name" value="{{ b.employee_name }}">
            <input type="hidden" name="year" value="{{ year }}">
            <input type="number" step="0.25" class="form-control form-control-sm me-2"
                   name="entitlement" placeholder="{{ b.total_entitlement }}">
            <button class="btn btn-primary btn-sm">Save</button>
        </form>
    </td>

    <!-- Update Balance -->
    <td>
        <form method="POST" action="/update_balance" class="d-flex">
            <input type="hidden" name="name" value="{{ b.employee_name }}">
            <input type="hidden" name="year" value="{{ year }}">
            <input type="number" step="0.25" class="form-control form-control-sm me-2"
                   name="balance" placeholder="{{ b.remaining }}">
            <button class="btn btn-warning btn-sm">Save</button>
        </form>
    </td>

    <!-- Rename -->
    <td>
        <form method="POST" action="/update_employee_name" class="d-flex">
            <input type="hidden" name="old_name" value="{{ b.employee_name }}">
            <input class="form-control form-control-sm me-2" name="new_name" placeholder="New name">
            <button class="btn btn-info btn-sm">Rename</button>
        </form>
    </td>

    <!-- Delete -->
    <td>
        <form method="POST" action="/delete_employee"
              onsubmit="return confirm('Delete {{ b.employee_name }}?');">
            <input type="hidden" name="name" value="{{ b.employee_name }}">
            <button class="btn btn-danger btn-sm">Delete</button>
        </form>
    </td>
</tr>
{% endfor %}
</tbody>
</table>

{% endblock %}
