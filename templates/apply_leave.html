{% extends 'base.html' %}
{% block content %}

<h4>Apply for Leave</h4>

<form method="post" id="applyForm">

  <!-- Employee -->
  <div class="mb-3">
    <label class="form-label">Employee</label>
    <select class="form-select" name="employee" id="employeeSelect" required>
      <option value="">-- Select name --</option>
      {% for e in employees %}
      <option value="{{ e.name }}">{{ e.name }}</option>
      {% endfor %}
    </select>

    <div class="form-text" id="balanceText" style="display:none;">
      Balance: <strong><span id="balVal">0</span> days</strong>
    </div>
  </div>

  <!-- Leave Type -->
  <div class="mb-3">
    <label class="form-label">Leave Type</label>
    <select class="form-select" name="leave_type" id="leaveType">
      <option>Annual</option>
      <option>Medical</option>
      <option>Unpaid</option>
      <option>Emergency</option>
    </select>
  </div>

  <!-- Dates -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Start Date</label>
      <input type="date" name="start_date" id="startDate" class="form-control" required>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">End Date</label>
      <input type="date" name="end_date" id="endDate" class="form-control" required>
    </div>
  </div>

  <!-- Half day -->
  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="halfDay" name="half">
    <label class="form-check-label" for="halfDay">Half-day (subtract 0.5)</label>
  </div>

  <!-- Days Auto Calc -->
  <div class="mb-3">
    <label class="form-label">Total Days</label>
    <input type="number" name="days" id="daysInput" class="form-control" step="0.5" required readonly>
    <small class="text-muted">Automatically calculated</small>
  </div>

  <!-- Reason -->
  <div class="mb-3">
    <label class="form-label">Reason</label>
    <textarea name="reason" class="form-control" placeholder="Optional"></textarea>
  </div>

  <button class="btn btn-primary">Submit</button>
</form>

<script>
function fetchBalance(name) {
  if (!name) {
    document.getElementById("balanceText").style.display = "none";
    return;
  }

  fetch("/balance/" + encodeURIComponent(name))
    .then(r => r.json())
    .then(data => {
      document.getElementById("balVal").innerText = Number(data.balance).toFixed(2);
      document.getElementById("balanceText").style.display = "block";
      calcDays();
    });
}

function calcDays() {
  let s = document.getElementById("startDate").value;
  let e = document.getElementById("endDate").value;
  if (!s || !e) return;

  let sd = new Date(s);
  let ed = new Date(e);

  let days = (ed - sd) / (1000 * 60 * 60 * 24) + 1;

  // invalid date
  if (isNaN(days) || days < 0) {
    document.getElementById("daysInput").value = "";
    return;
  }

  // Half day
  if (document.getElementById("halfDay").checked) {
    days -= 0.5;
  }

  document.getElementById("daysInput").value = days.toFixed(1);

  let bal = parseFloat(document.getElementById("balVal").innerText || 0);

  // Warning if more than balance
  let existingWarn = document.getElementById("warn");
  if (days > bal) {
    if (!existingWarn) {
      let div = document.createElement("div");
      div.id = "warn";
      div.className = "alert alert-warning mt-2";
      div.innerText = "Warning: Applying more than available balance.";
      document.getElementById("applyForm").prepend(div);
    }
  } else if (existingWarn) {
    existingWarn.remove();
  }
}

// Event listeners
document.getElementById("employeeSelect").addEventListener("change", function() {
  fetchBalance(this.value);
});

document.getElementById("startDate").addEventListener("change", calcDays);
document.getElementById("endDate").addEventListener("change", calcDays);
document.getElementById("halfDay").addEventListener("change", calcDays);
</script>

{% endblock %}
